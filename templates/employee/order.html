{% extends 'employee/base.html' %}
{% load static %}

{% block title %}Product Management{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/exp.css' %}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

  <!-- Button to trigger product creation form -->
  <div class="create-order">
    <button id="createorderBtn" class="btn btn-create"><i class="fas fa-plus"></i> Create Order</button>
  </div>

  <!-- Order Creation Form -->
  <div id="orderForm" class="order-form" style="display: none;">
    <label for="customer_id">Customer Name:</label>
    <select id="customer_id" name="customer_id" required>
      {% for customer in customers %}
        <option value="{{ customer.cust_id }}">{{ customer.cust_name }}</option>
      {% endfor %}
    </select>
    
    <label for="product_id">Product Name:</label>
    <select id="product_id" name="product_id" required>
      {% for product in products %}
        <option value="{{ product.pro_id }}">{{ product.category }}  ->  {{ product.name }}</option>
      {% endfor %}
    </select>

    <label for="order_created">Order Created on:</label>
    <input type="date" id="order_created" name="order_created" required>

    <label for="order_qt">Quantity:</label>
    <input type="number" id="order_qt" name="order_qt" required>

    <!-- Submit and reset buttons -->
    <button type="button" class="btn btn-submit" onclick="add_order()">Submit</button>
    <button type="button" class="btn btn-reset" onclick="resetForm()">Reset</button>
  </div>

  <!-- Order Details Table -->
  <div class="table-container">
    <h2 style="text-align: center;">Order Details</h2>
    <table>
      <thead>
        <tr>
          <th>Serial Number</th>
          <th>Customer Name</th>
          <th>Category</th>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Created On</th>
          <th>Order ID</th>
          <th>Customer ID</th>
          <th>Product ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr id="row-{{ order.order_id }}">
          <td>{{forloop.counter}}</td>
          <td>{{ order.customerfk.cust_name }}</td>
          <td>{{ order.productfk.category }}</td>
          <td>{{ order.productfk.name }}</td>
          <td>{{ order.total_qt }}  Kg</td>
          <td>{{order.created_att}}</td>
          <td>{{ order.order_id }}</td>
          <td>{{ order.customerfk.cust_id }}</td>
          <td>{{ order.productfk.pro_id }}</td>
          <td>
            <div class="action-btns">
            <button class="btn btn-edit" onclick="editRow('{{order.order_id}}')"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn btn-delete" onclick="deleteorder('{{ order.order_id }}');"><i class="fas fa-trash-alt"></i> Delete</button>
            </div>
          </td>
        </tr>
        <tr id="form-{{ order.order_id }}" class="edit-form" style="display: none;">
          <td>{{forloop.counter}}</td>
          <td>{{ order.customerfk.cust_name }}</td>
          <td>{{ order.productfk.category }}</td>
          <td>{{ order.productfk.name }}</td>
          <td><input type="number" id="ototal{{ order.order_id }}" value="{{ order.total_qt }}"></td>
          <td><input type="date" id="oupdated{{ order.order_id }}" value="{{ order.created_att}}"></td>
          <td>{{ order.order_id }}</td>
          <td>
            <select id="ocustomer{{ order.order_id }}">
                {% for customer in customers %}
                    <option value="{{ customer.cust_id }}" {% if customer.cust_id == order.customerfk.cust_id %}selected{% endif %}>{{customer.cust_id }}</option>
                {% endfor %}
            </select>
          </td>
          <td>
              <select id="oproduct{{ order.order_id }}">
                  {% for product in products %}
                      <option value="{{ product.pro_id }}" {% if product.pro_id == order.productfk.pro_id %}selected{% endif %}>{{product.pro_id }}</option>
                  {% endfor %}
              </select>
          </td>
          <td>
              <div class="action-btns">
                  <button class="btn btn-edit" onclick='saveChanges("{{ order.order_id }}");'>Save</button>
                  <button class="btn btn-delete" onclick="cancelEdit('{{ order.order_id }}')">Cancel</button>
              </div>
          </td>
      </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    // Toggle the order form visibility
    document.getElementById("createorderBtn").addEventListener("click", function() {
      var form = document.getElementById("orderForm");
      if (form.style.display === "none") {
          form.style.display = "block";
      } else {
          form.style.display = "none";
      }
  });

    // JavaScript function to submit the order form
    function add_order() {
      var customer_id = $("#customer_id").val();
      var product_id = $("#product_id").val();
      var order_created = $("#order_created").val();
      var order_qt = $("#order_qt").val();

      $.ajax({
        type: "POST",
        url: "{% url 'create_order' %}",
        data: {
          "customer_id": customer_id,
          "product_id": product_id,
          "order_created": order_created,
          "order_qt": order_qt,
        },
        success: function (data) {
          if (data.status === "pass") {
            alert("Order Successfully Edited")
            window.location.reload();  // Reload the page to show updated order details
          } else {
            alert(data.message);
          }
        },
        error: function (error) {
          alert("An error occurred.");
        }
      });
    }

    function saveChanges(order_id) {
      // Get the values from the input fields
      var ordertotal = $('#ototal' + order_id).val();
      var product_id = $('#oproduct' + order_id).val(); // Get selected product ID
      var customer_id = $('#ocustomer' + order_id).val();
      var orderdate = $('#oupdated' + order_id).val();
  
      // Confirm the action
      if (confirm('Are you sure you want to edit this order?')) {
          $.ajax({
              type: 'POST',
              url: "{% url 'edit_order' %}",
              data: {
                  "id": order_id,
                  "ordertotal": ordertotal,
                  "product_id": product_id,// Include the product ID in the data
                  "ctdate":orderdate,
                  "customer_id":customer_id,
              },
              success: function (data) {
                  if (data.status === 'out_of_stock') {
                          alert(data.message);  // Display the out-of-stock message
                  } else if (data.status === 'success') {
                          alert("Order updated successfully!");
                          window.location.replace('/u_order');
                  }
              },
              error: function (xhr, status, error) {
                  console.error("Error updating order:", status, error);
                  alert("An error occurred while updating the order. Please try again.");
              }
          });
      }
  }
  

        function deleteorder(order_id) {
          $.ajax({
            type: "POST",
            url: "{% url 'delete_order' %}",
            data: {
              "order_id": order_id,
            },
            success: function() {
              window.location.reload();
            }
          });
        }
    
        function editRow(id) {
                $('#row-'+id).hide();
                $('#form-'+id).show();
            }
    
        function cancelEdit(id) {
                $('#form-' +id).hide();
                $('#row-' +id).show();
        }

    // JavaScript function to reset the form
    function resetForm() {
       document.getElementById("customer_id").value = "";
       document.getElementById("product_id").value = "";
       document.getElementById("order_created").value = "";
       document.getElementById("order_qt").value = "";
     
   }

  </script>
</body>
</html>
{% endblock %}